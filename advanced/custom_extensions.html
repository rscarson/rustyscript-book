<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Custom Extensions - Rustyscript Documentation</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../getting_started/index.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../getting_started/hello_world.html"><strong aria-hidden="true">1.1.</strong> Hello World</a></li><li class="chapter-item expanded "><a href="../getting_started/calling_functions.html"><strong aria-hidden="true">1.2.</strong> Calling Functions</a></li><li class="chapter-item expanded "><a href="../getting_started/errors.html"><strong aria-hidden="true">1.3.</strong> Error Handling</a></li><li class="chapter-item expanded "><a href="../getting_started/using_javascript_types_in_rust.html"><strong aria-hidden="true">1.4.</strong> Using JavaScript Types in Rust</a></li><li class="chapter-item expanded "><a href="../getting_started/modules.html"><strong aria-hidden="true">1.5.</strong> On Modules and import</a></li><li class="chapter-item expanded "><a href="../getting_started/sandbox.html"><strong aria-hidden="true">1.6.</strong> The Sandbox</a></li><li class="chapter-item expanded "><a href="../getting_started/runtime_options.html"><strong aria-hidden="true">1.7.</strong> Runtime Options</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../getting_started/extension_options.html"><strong aria-hidden="true">1.7.1.</strong> Extension Options</a></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../advanced/index.html"><strong aria-hidden="true">2.</strong> Advanced Topics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/asynchronous_javascript.html"><strong aria-hidden="true">2.1.</strong> Asynchronous JavaScript</a></li><li class="chapter-item expanded "><a href="../advanced/calling_rust_from_javascript.html"><strong aria-hidden="true">2.2.</strong> Calling Rust from JavaScript</a></li><li class="chapter-item expanded "><a href="../advanced/custom_extensions.html" class="active"><strong aria-hidden="true">2.3.</strong> Custom Extensions</a></li><li class="chapter-item expanded "><a href="../advanced/static_runtime.html"><strong aria-hidden="true">2.4.</strong> Static Runtimes</a></li><li class="chapter-item expanded "><a href="../advanced/multithreading.html"><strong aria-hidden="true">2.5.</strong> Multi-Threading</a></li><li class="chapter-item expanded "><a href="../advanced/nodejs_compatibility.html"><strong aria-hidden="true">2.6.</strong> NodeJS Compatibility</a></li><li class="chapter-item expanded "><a href="../advanced/permissions.html"><strong aria-hidden="true">2.7.</strong> Permissions</a></li><li class="chapter-item expanded "><a href="../advanced/snapshots.html"><strong aria-hidden="true">2.8.</strong> Snapshots</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../extensions/index.html"><strong aria-hidden="true">3.</strong> Extensions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../extensions/safe_extensions.html"><strong aria-hidden="true">3.1.</strong> Safe Extensions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../extensions/console.html"><strong aria-hidden="true">3.1.1.</strong> Console</a></li><li class="chapter-item expanded "><a href="../extensions/crypto.html"><strong aria-hidden="true">3.1.2.</strong> Crypto</a></li><li class="chapter-item expanded "><a href="../extensions/url.html"><strong aria-hidden="true">3.1.3.</strong> Url</a></li><li class="chapter-item expanded "><a href="../extensions/web_stub.html"><strong aria-hidden="true">3.1.4.</strong> Web Stub</a></li></ol></li><li class="chapter-item expanded "><a href="../extensions/io_extensions.html"><strong aria-hidden="true">3.2.</strong> IO Extensions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../extensions/cache.html"><strong aria-hidden="true">3.2.1.</strong> Cache</a></li><li class="chapter-item expanded "><a href="../extensions/cron.html"><strong aria-hidden="true">3.2.2.</strong> Cron</a></li><li class="chapter-item expanded "><a href="../extensions/ffi.html"><strong aria-hidden="true">3.2.3.</strong> FFI</a></li><li class="chapter-item expanded "><a href="../extensions/fs.html"><strong aria-hidden="true">3.2.4.</strong> FS</a></li><li class="chapter-item expanded "><a href="../extensions/io.html"><strong aria-hidden="true">3.2.5.</strong> IO</a></li><li class="chapter-item expanded "><a href="../extensions/kv.html"><strong aria-hidden="true">3.2.6.</strong> KV</a></li><li class="chapter-item expanded "><a href="../extensions/webgpu.html"><strong aria-hidden="true">3.2.7.</strong> WebGPU</a></li></ol></li><li class="chapter-item expanded "><a href="../extensions/network_extensions.html"><strong aria-hidden="true">3.3.</strong> Network Extensions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../extensions/broadcast_channel.html"><strong aria-hidden="true">3.3.1.</strong> Broadcast Channel</a></li><li class="chapter-item expanded "><a href="../extensions/http.html"><strong aria-hidden="true">3.3.2.</strong> HTTP</a></li><li class="chapter-item expanded "><a href="../extensions/web.html"><strong aria-hidden="true">3.3.3.</strong> Web</a></li><li class="chapter-item expanded "><a href="../extensions/websocket.html"><strong aria-hidden="true">3.3.4.</strong> WebSocket</a></li><li class="chapter-item expanded "><a href="../extensions/webstorage.html"><strong aria-hidden="true">3.3.5.</strong> WebStorage</a></li></ol></li><li class="chapter-item expanded "><a href="../extensions/nodejs_extensions.html"><strong aria-hidden="true">3.4.</strong> NodeJS Extensions</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Rustyscript Documentation</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="custom-extensions"><a class="header" href="#custom-extensions">Custom Extensions</a></h1>
<blockquote>
<p><strong>Important note:</strong> that the examples in this chapter require your crate to supply the <strong>same version</strong> of <a href="https://crates.io/crates/deno_core"><code>deno_core</code></a> as rustyscript uses - this version can be checked <a href="https://crates.io/crates/rustyscript/latest/dependencies">here</a></p>
</blockquote>
<p>The most performant way to extend rustyscript is to use the <code>extension</code> feature of deno_core.<br />
The following example demonstrates how to create a simple extension that adds two numbers together.</p>
<pre><pre class="playground"><code class="language-rust">use rustyscript::{Error, Runtime, RuntimeOptions};
use deno_core::{extension, op2};

#[op2(fast)]
#[bigint]
fn op_add_example(#[bigint] a: i64, #[bigint] b: i64) -&gt; i64 {
    a + b
}

extension!(
    example_extension,                                  // The name of the extension
    ops = [op_add_example],                             // The ops to include in the extension
    esm_entry_point = &quot;simple_extension.js&quot;,            // The entry point for the extension
    esm = [ dir &quot;js_examples&quot;, &quot;simple_extension.js&quot; ], // The javascript files to include
);

fn main() -&gt; Result&lt;(), Error&gt; {
    // If you were loading from a snapshot, you would use init_ops instead of init_ops_and_esm
    // let my_extension = example_extension::init_ops();
    let my_extension = example_extension::init_ops_and_esm();

    let mut runtime = Runtime::new(RuntimeOptions {
        extensions: vec![my_extension],
        ..Default::default()
    })?;

    let result: i64 = runtime.eval(&quot;my_add(5, 5)&quot;)?;
    assert_eq!(10, result);

    Ok(())
}
</code></pre></pre>
<p>And the corresponding javascript file:</p>
<pre><code class="language-javascript norun">export const add = (a, b) =&gt; Deno.core.ops.op_add_example(a, b);
globalThis.my_add = add;
</code></pre>
<blockquote>
<p><strong>Important note:</strong> All javascript files included in an extension MUST be included somewhere.
I recommend using the file specified in <code>esm_entry_point</code> to include all other files.</p>
</blockquote>
<h2 id="op2"><a class="header" href="#op2">Op2</a></h2>
<p><code>Op2</code> is a deno-provided macro that allows you to define an extension function.</p>
<ul>
<li>The supported types for arguments can be found listed in <a href="https://github.com/denoland/deno_core/blob/main/ops/op2/valid_args.md">https://github.com/denoland/deno_core/blob/main/ops/op2/valid_args.md</a></li>
<li>And return types, here: <a href="https://github.com/denoland/deno_core/blob/main/ops/op2/valid_retvals.md">https://github.com/denoland/deno_core/blob/main/ops/op2/valid_retvals.md</a></li>
</ul>
<p>The <code>fast</code> attribute used when possible to denote that the types involved can be converted fast. Don't stress too much on when to use this, as the compiler will tell you if you need it, or do not.</p>
<p>Ops defined in an extension can then be called from javascript using <code>Deno.core.ops.op_name(args...)</code>.</p>
<hr />
<p>Async functions can be defined as well. </p>
<p>Let us break down a more complex example taken from rustyscript's own internals:</p>
<pre><pre class="playground"><code class="language-rust norun">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[op2(async)]
#[serde]
fn call_registered_function_async(
    #[string] name: String,
    #[serde] args: Vec&lt;serde_json::Value&gt;,
    state: &amp;mut OpState,
) -&gt; impl std::future::Future&lt;Output = Result&lt;serde_json::Value, Error&gt;&gt; {
    if state.has::&lt;AsyncFnCache&gt;() {
        let table = state.borrow_mut::&lt;AsyncFnCache&gt;();
        if let Some(callback) = table.get(&amp;name) {
            return callback(args);
        }
    }

    Box::pin(std::future::ready(Err(Error::ValueNotCallable(name))))
}
<span class="boring">}
</span></code></pre></pre>
<ul>
<li><code>#[op2(async)]</code> is used to denote that this is an async function - it must return a <code>Future</code> of some kind 
<ul>
<li>Potential pitfall: <strong>the returned future cannot have a lifetime</strong></li>
</ul>
</li>
<li><code>#[serde]</code> means that the return value will be a type decoded with <code>serde::Deserialize</code>.
<ul>
<li>In this fase, there return value is <code>Future&lt;Output = Result&lt;serde_json::Value, Error&gt;&gt;</code> - A future that resolves to a <code>serde_json::Value</code>, or an error.</li>
</ul>
</li>
<li>The arguments are annotated with <code>#[string]</code> and <code>#[serde]</code> to denote that they are a string, and a deserializable type, respectively.
<ul>
<li>The <code>state</code> argument is a special case that can be used for persistent storage inside of ops. In this case, it is used to store a cache.</li>
</ul>
</li>
</ul>
<p>And finally, the returned future is run through <code>Box::pin</code> before being returned.</p>
<hr />
<p>You can also customize the names of your extension modules<br />
If you instead define the extension as follows:</p>
<pre><pre class="playground"><code class="language-rust norun">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>extension!(
    example_extension,
    ops = [op_add_example],
    esm_entry_point = &quot;example:calculator&quot;,
    esm = [ dir &quot;examples/example_extension&quot;, &quot;example:calculator&quot; = &quot;example_extension.js&quot; ],
);
<span class="boring">}
</span></code></pre></pre>
<p>Then provide a schema whitelist in your <code>RuntimeOptions</code>:</p>
<pre><pre class="playground"><code class="language-rust norun">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    let mut schema_whlist = HashSet::new();
    schema_whlist.insert(&quot;example:&quot;.to_string());
    options.schema_whlist = schema_whlist;
<span class="boring">}
</span></code></pre></pre>
<p>You would be able to <code>import { add } from &quot;example:calculator&quot;;</code> from inside of your js modules.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../advanced/calling_rust_from_javascript.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../advanced/static_runtime.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../advanced/calling_rust_from_javascript.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../advanced/static_runtime.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
